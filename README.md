# ElasticApiKeyBackendClient

A custom JMeter Backend Listener that pushes sample results to Elasticsearch using the Elasticsearch Bulk API with API Key authentication.

## Features

✅ Sends performance test metrics from JMeter to Elasticsearch in near real-time  
✅ Supports batching of results for performance  
✅ Works with Elasticsearch API Key security  
✅ Includes a per-test unique `run_id` (GUID) to group results  
✅ Captures assertions, response codes, messages, and optionally the response body  
✅ Supports transaction controllers aggregation  
✅ Built with extendability in mind

## Configuration Parameters

| Parameter                        | Description                                                                            | Default                       |
|----------------------------------|----------------------------------------------------------------------------------------|-------------------------------|
| `es.url`                         | Elasticsearch Bulk API endpoint                                                        | `http://localhost:9200/_bulk` |
| `es.api.key`                     | Your Elasticsearch API Key                                                             | `YOUR_API_KEY`                |
| `environment`                    | Environment name (e.g. `staging`, `prod`)                                              | `perf_cmp_2`                  |
| `type`                           | Type of test or component                                                              | `api`                         |
| `transaction.controller.prefix`  | Prefix to identify transaction controllers, the exmaple of the full name is 'TC_Login' | `TC`                          |
| `batch.size`                     | Number of samples to send per bulk request                                             | `1000`                        |
| `save.response.body`             | Controls saving response body (`always`, `onError`, `off`)                             | `onError`                     |

## How it Works

- On test start, the plugin generates a unique `run_id` (UUID) to tag all results.
- Samples are processed recursively, capturing the main sample and any sub-results.
- Results are collected into a JSON batch in Elasticsearch bulk format.
- Once the batch size is reached, the payload is pushed to Elasticsearch via HTTP POST with an `ApiKey` authorization header.
- Metrics include assertions, timing, response codes, and JMeter thread group info.

## Example Elasticsearch Document

```json
{
  "threadName": "Thread Group 1-1",
  "label": "HTTP Request",
  "parentLabel": null,
  "isTransactionController": false,
  "success": true,
  "responseTime": 123,
  "responseCode": "200",
  "responseMessage": "OK",
  "responseBody": "",
  "assertions": "",
  "time_stamp": "2025-07-03T13:45:00Z",
  "activeThreads": 5,
  "startedThreads": 10,
  "finishedThreads": 5,
  "environment": "perf_cmp_2",
  "type": "api",
  "run_id": "fe392fd2-0d82-4b7f-b3e3-d69fa3d30888"
}
```

## Installation

1. Download the latest release or build the JAR:

    ```bash
    .\gradlew shadowJar
    ```

2. Copy the generated JAR file into your JMeter `lib/ext` directory.

3. Restart JMeter.

4. In your JMeter test plan, add a **Backend Listener**, and select:

    ```
    io.github.mderevyankoaqa.es.visualizer.ElasticApiKeyBackendClient
    ```

5. Configure its parameters as shown in the table above.

## Notes

- Ensure your Elasticsearch index is mapped to accept the fields generated by this plugin.
- If you store response bodies, be aware of potentially large documents exceeding Elasticsearch’s document size limits.
- The plugin uses `application/x-ndjson` for Elasticsearch Bulk API compatibility.

## Compatibility

- **Supported JMeter**: 5.6.3
- **Minimum Java version**: 11

## License

Apache 2.0 — feel free to use, modify, and extend.